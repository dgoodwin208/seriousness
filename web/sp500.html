<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S&P 500 Seriousness Analysis - IsXSerious.com</title>
    <meta name="description" content="Interactive 3D visualization of the thermodynamic seriousness of S&P 500 companies. Explore how America's largest companies contribute to or detract from systemic order.">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://isxserious.com/sp500.html">
    <meta property="og:title" content="S&P 500 Seriousness Analysis - IsXSerious.com">
    <meta property="og:description" content="Interactive 3D visualization of the thermodynamic seriousness of S&P 500 companies. Explore how America's largest companies contribute to or detract from systemic order.">
    <meta property="og:image" content="https://isxserious.com/preview_compressed.jpg">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://isxserious.com/sp500.html">
    <meta property="twitter:title" content="S&P 500 Seriousness Analysis - IsXSerious.com">
    <meta property="twitter:description" content="Interactive 3D visualization of the thermodynamic seriousness of S&P 500 companies. Explore how America's largest companies contribute to or detract from systemic order.">
    <meta property="twitter:image" content="https://isxserious.com/preview_compressed.jpg">

    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script defer src="https://cdn.vercel-insights.com/v1/script.js"></script>
    <style>
        .viz-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        .viz-controls {
            text-align: center;
            margin-bottom: 2rem;
        }

        .toggle-btn {
            padding: 12px 24px;
            margin: 0 10px;
            background: white;
            border: 2px solid #3498db;
            color: #3498db;
            border-radius: 5px;
            font-family: 'Crimson Text', serif;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle-btn.active {
            background: #3498db;
            color: white;
        }

        .toggle-btn:hover {
            background: #3498db;
            color: white;
        }

        #plot-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 1rem;
            min-height: 700px;
            overflow: hidden;
        }

        .viz-layout {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1rem;
        }

        #rationale-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
            max-height: 700px;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        #rationale-panel h3 {
            margin-top: 0;
            color: #2c3e50;
            font-size: 1.3rem;
        }

        #rationale-panel .company-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: #3498db;
            margin-bottom: 0.5rem;
        }

        #rationale-panel .company-info {
            font-size: 0.95rem;
            color: #6c757d;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e9ecef;
        }

        #rationale-panel .rationale-text {
            font-size: 1.05rem;
            line-height: 1.7;
            color: #2c3e50;
        }

        #rationale-panel .placeholder {
            color: #6c757d;
            font-style: italic;
            text-align: center;
            padding: 2rem 0;
        }

        .projections-grid {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .projection-item {
            background: white;
            width: 100%;
        }

        .stats-container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 2rem;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 600;
            color: #3498db;
        }

        .stat-label {
            font-size: 0.95rem;
            color: #6c757d;
            margin-top: 0.5rem;
        }

        .filter-controls {
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .filter-controls select {
            padding: 8px 16px;
            margin: 0 10px;
            border: 2px solid #e9ecef;
            border-radius: 5px;
            font-family: 'Crimson Text', serif;
            font-size: 1rem;
            background: white;
        }

        @media (max-width: 1024px) {
            .viz-layout {
                grid-template-columns: 1fr;
            }

            #rationale-panel {
                max-height: 400px;
            }
        }

        /* Data Table Styles */
        .table-container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .table-controls {
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
        }

        .search-box input {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            border-radius: 5px;
            font-family: 'Crimson Text', serif;
            font-size: 1rem;
        }

        .search-box input:focus {
            outline: none;
            border-color: #3498db;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
        }

        .data-table thead {
            background: #f8f9fa;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table th {
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            color: #2c3e50;
            border-bottom: 2px solid #e9ecef;
            cursor: pointer;
            user-select: none;
        }

        .data-table th:hover {
            background: #e9ecef;
        }

        .data-table th.sortable::after {
            content: ' ↕';
            color: #bdc3c7;
            font-size: 0.8rem;
        }

        .data-table th.sorted-asc::after {
            content: ' ↑';
            color: #3498db;
        }

        .data-table th.sorted-desc::after {
            content: ' ↓';
            color: #3498db;
        }

        .data-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #e9ecef;
            color: #2c3e50;
        }

        .data-table tbody tr:hover {
            background: #f8f9fa;
        }

        .data-table .company-name {
            font-weight: 600;
            color: #3498db;
        }

        .data-table .score-positive {
            color: #27ae60;
            font-weight: 600;
        }

        .data-table .score-negative {
            color: #e74c3c;
            font-weight: 600;
        }

        .data-table .score-neutral {
            color: #f39c12;
            font-weight: 600;
        }

        .designation-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .designation-serious {
            background: #d4edda;
            color: #27ae60;
        }

        .designation-antiSerious {
            background: #f8d7da;
            color: #e74c3c;
        }

        .designation-unserious {
            background: #fff3cd;
            color: #f39c12;
        }

        @media (max-width: 768px) {
            .data-table {
                font-size: 0.85rem;
            }

            .data-table th,
            .data-table td {
                padding: 8px 4px;
            }
        }
    </style>
    <script src="nav.js"></script>
</head>
<body>
    <header>
        <nav></nav>
    </header>

    <main>
        <section class="hero">
            <div class="container">
                <h1>S&P 500 Seriousness Analysis</h1>
                <p class="subtitle">Thermodynamic evaluation of America's largest companies</p>
            </div>
        </section>

        <section class="viz-container">
            <div class="viz-controls">
                <button class="toggle-btn active" id="btn-3d">3D View</button>
                <button class="toggle-btn" id="btn-2d">2D Projections</button>
            </div>

            <div class="filter-controls">
                <label for="sector-filter">Filter by Sector:</label>
                <select id="sector-filter">
                    <option value="all">All Sectors</option>
                </select>

                <label for="designation-filter">Filter by Designation:</label>
                <select id="designation-filter">
                    <option value="all">All Designations</option>
                    <option value="Serious">Serious</option>
                    <option value="Anti-serious">Anti-serious</option>
                    <option value="Unserious">Unserious</option>
                    <option value="Serious (contested)">Serious (contested)</option>
                </select>
            </div>

            <div class="viz-layout">
                <div id="plot-container"></div>
                <div id="rationale-panel">
                    <h3>Company Details</h3>
                    <div class="placeholder">Hover over a company to see details</div>
                </div>
            </div>
        </section>

        <section class="stats-container">
            <h2 style="text-align: center; margin-bottom: 1rem;">Dataset Statistics</h2>
            <div class="stats-grid" id="stats-grid"></div>
        </section>

        <section class="table-container">
            <h2 style="text-align: center; margin-bottom: 1.5rem;">Company Data Table</h2>

            <div class="table-controls">
                <div class="search-box">
                    <input type="text" id="table-search" placeholder="Search companies...">
                </div>
                <div style="color: #6c757d; font-size: 0.9rem;">
                    <span id="row-count">0</span> companies
                </div>
            </div>

            <div style="overflow-x: auto;">
                <table class="data-table" id="company-table">
                    <thead>
                        <tr>
                            <th class="sortable" data-column="security">Company</th>
                            <th class="sortable" data-column="symbol">Symbol</th>
                            <th class="sortable" data-column="sector">Sector</th>
                            <th class="sortable" data-column="weight">Weight %</th>
                            <th class="sortable" data-column="E_adj">E</th>
                            <th class="sortable" data-column="v_adj">v</th>
                            <th class="sortable" data-column="alpha_adj">α</th>
                            <th class="sortable" data-column="magnitude">Magnitude</th>
                            <th class="sortable" data-column="designation">Designation</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <!-- Populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </section>

        <section class="about-section">
            <div class="container">
                <h2>About This Analysis</h2>
                <p>This visualization shows the thermodynamic seriousness of S&P 500 companies across three dimensions:</p>

                <div class="framework-explanation">
                    <div class="parameter">
                        <h3>E (Energy & Resources)</h3>
                        <p>Does the company add net new resources (funding, power, materials) to the US economy?</p>
                    </div>
                    <div class="parameter">
                        <h3>v (Infrastructure & Efficiency)</h3>
                        <p>Does the company build durable capacity and enhance resource utilization?</p>
                    </div>
                    <div class="parameter">
                        <h3>α (Order & Coordination)</h3>
                        <p>Does the company reduce disorder, inspire cooperation, or increase division?</p>
                    </div>
                </div>

                <p style="margin-top: 2rem;">
                    Each sphere's size represents the company's weight in the S&P 500 index.
                    Toggle between 3D and 2D views to explore different perspectives of the data.
                    Hover over any company to see detailed information.
                </p>
            </div>
        </section>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 IsXSerious.com - A project exploring the physics of cultural progress</p>
        </div>
    </footer>

    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://ausdneaevmkubvsygwdo.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF1c2RuZWFldm1rdWJ2c3lnd2RvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1NDMyNDAsImV4cCI6MjA3NjExOTI0MH0.H5_XhCEqzr4IxqQxue9-tWPYOMNf6kpJc05yKHdacHs';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let dataset = [];
        let currentView = '3d';
        let currentSectorFilter = 'all';
        let currentDesignationFilter = 'all';
        let selectedCompany = null;

        // Load data from Supabase
        async function loadData() {
            try {
                // Get all S&P 500 evaluations from Supabase
                // Filter by 'sp500' in the categories array
                const { data: evaluations, error } = await supabase
                    .from('evaluations')
                    .select(`
                        *,
                        evaluation_targets!inner (
                            name,
                            metadata
                        )
                    `)
                    .eq('context', 'United States')
                    .eq('model', 'claude-3-7-sonnet-20250219')
                    .eq('prompt_version', '1.0')
                    .contains('evaluation_targets.metadata', { categories: ['sp500'] });

                if (error) throw error;

                // Transform data to match expected format
                dataset = evaluations.map(d => ({
                    symbol: d.evaluation_targets.metadata?.Symbol || '',
                    security: d.evaluation_targets.name,
                    sector: d.evaluation_targets.metadata?.['GICS Sector'] || 'Unknown',
                    subIndustry: d.evaluation_targets.metadata?.['GICS Sub-Industry'] || '',
                    headquarters: d.evaluation_targets.metadata?.['Headquarters Location'] || '',
                    weight: parseFloat(d.evaluation_targets.metadata?.Weight?.replace('%', '') || 0),
                    E_adj: d.e_adj,
                    v_adj: d.v_adj,
                    alpha_adj: d.alpha_adj,
                    designation: d.designation,
                    rationale: d.rationale,
                    magnitude: Math.sqrt(
                        Math.pow(d.e_adj, 2) +
                        Math.pow(d.v_adj, 2) +
                        Math.pow(d.alpha_adj, 2)
                    )
                }));

                // Populate sector filter
                const sectors = [...new Set(dataset.map(d => d.sector))].sort();
                const sectorFilter = document.getElementById('sector-filter');
                sectors.forEach(sector => {
                    const option = document.createElement('option');
                    option.value = sector;
                    option.textContent = sector;
                    sectorFilter.appendChild(option);
                });

                updateStats();
                renderTable();
                render3D();
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('plot-container').innerHTML =
                    `<div style="padding: 2rem; text-align: center; color: #e74c3c;">
                        Error loading data: ${error.message}
                    </div>`;
            }
        }

        // Load data on page load
        loadData();

        function getFilteredData() {
            return dataset.filter(d => {
                const sectorMatch = currentSectorFilter === 'all' || d.sector === currentSectorFilter;
                const designationMatch = currentDesignationFilter === 'all' || d.designation === currentDesignationFilter;
                return sectorMatch && designationMatch;
            });
        }

        function updateRationalePanel(company, isPinned = false) {
            const panel = document.getElementById('rationale-panel');
            if (!company) {
                panel.innerHTML = `
                    <h3>Company Details</h3>
                    <div class="placeholder">Click on a company to pin details, or hover to preview</div>
                `;
                return;
            }

            const pinnedIndicator = isPinned ?
                ' <span style="color: #6c757d; font-size: 0.9rem;">(Pinned - click another to change or <a href="#" id="unpin-link" style="color: #3498db; text-decoration: underline; cursor: pointer;">click here</a> to release)</span>' : '';

            panel.innerHTML = `
                <h3>Company Details${pinnedIndicator}</h3>
                <div class="company-name">${company.security}</div>
                <div class="company-info">
                    <strong>Symbol:</strong> ${company.symbol}<br>
                    <strong>Sector:</strong> ${company.sector}<br>
                    <strong>Sub-Industry:</strong> ${company.subIndustry}<br>
                    <strong>Headquarters:</strong> ${company.headquarters}<br>
                    <strong>S&P 500 Weight:</strong> ${company.weight.toFixed(2)}%<br>
                    <strong>Designation:</strong> ${company.designation}
                </div>
                <div class="company-info">
                    <strong>Dimensions:</strong><br>
                    E (Resources): ${company.E_adj.toFixed(2)}<br>
                    v (Infrastructure): ${company.v_adj.toFixed(2)}<br>
                    α (Order): ${company.alpha_adj.toFixed(2)}<br>
                    Magnitude: ${company.magnitude.toFixed(3)}
                </div>
                <h4 style="margin-top: 1rem; margin-bottom: 0.5rem;">Rationale</h4>
                <div class="rationale-text">${company.rationale}</div>
            `;

            // Add event listener for unpin link
            if (isPinned) {
                const unpinLink = document.getElementById('unpin-link');
                if (unpinLink) {
                    unpinLink.addEventListener('click', function(e) {
                        e.preventDefault();
                        selectedCompany = null;
                        updateRationalePanel(null);
                    });
                }
            }
        }

        function render3D() {
            const filteredData = getFilteredData();

            // Clear the container completely
            const container = document.getElementById('plot-container');
            container.innerHTML = '';

            const trace = {
                x: filteredData.map(d => d.E_adj),
                y: filteredData.map(d => d.v_adj),
                z: filteredData.map(d => d.alpha_adj),
                mode: 'markers',
                type: 'scatter3d',
                marker: {
                    size: filteredData.map(d => Math.max(5, d.weight * 10)),
                    color: filteredData.map(d => d.magnitude),
                    colorscale: 'Viridis',
                    opacity: 0.8,
                    line: {
                        color: 'white',
                        width: 0.5
                    },
                    showscale: false
                },
                text: filteredData.map(d =>
                    `<b>${d.security} (${d.symbol})</b><br>` +
                    `Sector: ${d.sector}<br>` +
                    `Designation: ${d.designation}<br>` +
                    `Weight: ${d.weight.toFixed(2)}%<br>` +
                    `E: ${d.E_adj.toFixed(2)}<br>` +
                    `v: ${d.v_adj.toFixed(2)}<br>` +
                    `α: ${d.alpha_adj.toFixed(2)}<br>` +
                    `Magnitude: ${d.magnitude.toFixed(3)}`
                ),
                hoverinfo: 'text',
                customdata: filteredData.map((d, i) => i),
                showlegend: false
            };

            // Add transparent planes at zero
            const planeRange = [-1, 1];
            const planeGrid = [planeRange, planeRange];

            // XY plane (z=0)
            const xyPlane = {
                type: 'surface',
                x: planeGrid,
                y: planeGrid,
                z: [[0, 0], [0, 0]],
                opacity: 0.15,
                colorscale: [[0, 'lightgray'], [1, 'lightgray']],
                showscale: false,
                hoverinfo: 'skip'
            };

            // XZ plane (y=0)
            const xzPlane = {
                type: 'surface',
                x: planeGrid,
                y: [[0, 0], [0, 0]],
                z: planeGrid,
                opacity: 0.15,
                colorscale: [[0, 'lightgray'], [1, 'lightgray']],
                showscale: false,
                hoverinfo: 'skip'
            };

            // YZ plane (x=0)
            const yzPlane = {
                type: 'surface',
                x: [[0, 0], [0, 0]],
                y: planeGrid,
                z: planeGrid,
                opacity: 0.15,
                colorscale: [[0, 'lightgray'], [1, 'lightgray']],
                showscale: false,
                hoverinfo: 'skip'
            };

            // Add axis lines
            const axisRange = [-1, 1];
            const axisLines = [
                {
                    x: axisRange, y: [0, 0], z: [0, 0],
                    mode: 'lines',
                    type: 'scatter3d',
                    line: { color: 'gray', width: 2 },
                    showlegend: false,
                    hoverinfo: 'skip'
                },
                {
                    x: [0, 0], y: axisRange, z: [0, 0],
                    mode: 'lines',
                    type: 'scatter3d',
                    line: { color: 'gray', width: 2 },
                    showlegend: false,
                    hoverinfo: 'skip'
                },
                {
                    x: [0, 0], y: [0, 0], z: axisRange,
                    mode: 'lines',
                    type: 'scatter3d',
                    line: { color: 'gray', width: 2 },
                    showlegend: false,
                    hoverinfo: 'skip'
                }
            ];

            const layout = {
                scene: {
                    xaxis: { title: 'Resources (E)', range: [-1, 1] },
                    yaxis: { title: 'Infrastructure (v)', range: [-1, 1] },
                    zaxis: { title: 'Order (α)', range: [-1, 1] },
                    bgcolor: 'white'
                },
                margin: { l: 0, r: 0, b: 0, t: 0 },
                height: 700,
                autosize: true,
                paper_bgcolor: 'white',
                plot_bgcolor: 'white'
            };

            Plotly.newPlot('plot-container', [xyPlane, xzPlane, yzPlane, trace, ...axisLines], layout, {responsive: true, displayModeBar: true})
                .then(() => {
                    // Re-attach event listeners after plot is created
                    const plotDiv = document.getElementById('plot-container');

                    plotDiv.on('plotly_click', function(data) {
                        const pointIndex = data.points[0].customdata;
                        if (pointIndex !== undefined) {
                            selectedCompany = filteredData[pointIndex];
                            updateRationalePanel(selectedCompany, true);
                        }
                    });

                    plotDiv.on('plotly_hover', function(data) {
                        if (!selectedCompany) {
                            const pointIndex = data.points[0].customdata;
                            if (pointIndex !== undefined) {
                                updateRationalePanel(filteredData[pointIndex], false);
                            }
                        }
                    });

                    plotDiv.on('plotly_unhover', function() {
                        if (!selectedCompany) {
                            updateRationalePanel(null);
                        }
                    });

                    // Show selected company if one was pinned
                    if (selectedCompany) {
                        updateRationalePanel(selectedCompany, true);
                    }
                });
        }

        function render2D() {
            const filteredData = getFilteredData();

            const createTrace = (x, y) => ({
                x: filteredData.map(d => d[x]),
                y: filteredData.map(d => d[y]),
                mode: 'markers',
                type: 'scatter',
                marker: {
                    size: filteredData.map(d => Math.max(5, d.weight * 15)),
                    color: filteredData.map(d => d.magnitude),
                    colorscale: 'Viridis',
                    opacity: 0.8,
                    line: {
                        color: 'white',
                        width: 0.5
                    }
                },
                text: filteredData.map(d =>
                    `<b>${d.security} (${d.symbol})</b><br>` +
                    `Sector: ${d.sector}<br>` +
                    `Designation: ${d.designation}<br>` +
                    `Weight: ${d.weight.toFixed(2)}%`
                ),
                hoverinfo: 'text',
                showlegend: false,
                customdata: filteredData.map((d, i) => i)
            });

            const projections = [
                { x: 'E_adj', y: 'v_adj', xlabel: 'Resources (E)', ylabel: 'Infrastructure (v)', title: 'Resources vs Infrastructure' },
                { x: 'E_adj', y: 'alpha_adj', xlabel: 'Resources (E)', ylabel: 'Order (α)', title: 'Resources vs Order' },
                { x: 'v_adj', y: 'alpha_adj', xlabel: 'Infrastructure (v)', ylabel: 'Order (α)', title: 'Infrastructure vs Order' }
            ];

            const container = document.getElementById('plot-container');
            container.innerHTML = '<div class="projections-grid" id="projections-grid"></div>';
            const grid = document.getElementById('projections-grid');

            projections.forEach(proj => {
                const div = document.createElement('div');
                div.className = 'projection-item';
                div.id = `proj-${proj.x}-${proj.y}`;
                grid.appendChild(div);

                const trace = createTrace(proj.x, proj.y);

                const layout = {
                    title: proj.title,
                    xaxis: {
                        title: proj.xlabel,
                        range: [-1, 1],
                        zeroline: true,
                        zerolinewidth: 2,
                        zerolinecolor: 'black',
                        scaleanchor: 'y',
                        scaleratio: 1
                    },
                    yaxis: {
                        title: proj.ylabel,
                        range: [-1, 1],
                        zeroline: true,
                        zerolinewidth: 2,
                        zerolinecolor: 'black',
                        constrain: 'domain'
                    },
                    width: 600,
                    height: 600,
                    margin: { l: 60, r: 20, b: 60, t: 40 },
                    paper_bgcolor: 'white',
                    plot_bgcolor: 'white'
                };

                Plotly.newPlot(div.id, [trace], layout, {responsive: false});

                // Add click and hover event listeners to each 2D plot
                const plotDiv = document.getElementById(div.id);

                plotDiv.on('plotly_click', function(data) {
                    const pointIndex = data.points[0].customdata;
                    if (pointIndex !== undefined) {
                        selectedCompany = filteredData[pointIndex];
                        updateRationalePanel(selectedCompany, true);
                    }
                });

                plotDiv.on('plotly_hover', function(data) {
                    if (!selectedCompany) {
                        const pointIndex = data.points[0].customdata;
                        if (pointIndex !== undefined) {
                            updateRationalePanel(filteredData[pointIndex], false);
                        }
                    }
                });

                plotDiv.on('plotly_unhover', function() {
                    if (!selectedCompany) {
                        updateRationalePanel(null);
                    }
                });
            });

            // Show selected company if one was pinned
            if (selectedCompany) {
                updateRationalePanel(selectedCompany, true);
            }
        }

        function updateStats() {
            const filteredData = getFilteredData();
            const statsGrid = document.getElementById('stats-grid');

            const stats = [
                { label: 'Total Companies', value: filteredData.length },
                { label: 'Serious', value: filteredData.filter(d => d.designation === 'Serious').length },
                { label: 'Anti-serious', value: filteredData.filter(d => d.designation === 'Anti-serious').length },
                { label: 'Unserious', value: filteredData.filter(d => d.designation === 'Unserious').length },
                { label: 'Avg Magnitude', value: (filteredData.reduce((sum, d) => sum + d.magnitude, 0) / filteredData.length).toFixed(3) },
                { label: 'Avg Weight', value: (filteredData.reduce((sum, d) => sum + d.weight, 0) / filteredData.length).toFixed(2) + '%' }
            ];

            statsGrid.innerHTML = stats.map(stat => `
                <div class="stat-card">
                    <div class="stat-value">${stat.value}</div>
                    <div class="stat-label">${stat.label}</div>
                </div>
            `).join('');
        }

        // Table functionality
        let currentSort = { column: null, direction: 'asc' };
        let searchTerm = '';

        function formatScore(value) {
            const formatted = value?.toFixed(2) || '0.00';
            if (value > 0.1) return `<span class="score-positive">${formatted}</span>`;
            if (value < -0.1) return `<span class="score-negative">${formatted}</span>`;
            return `<span class="score-neutral">${formatted}</span>`;
        }

        function getDesignationClass(designation) {
            if (designation === 'Serious') return 'designation-serious';
            if (designation === 'Anti-serious') return 'designation-antiSerious';
            return 'designation-unserious';
        }

        function renderTable() {
            updateTableDisplay();
        }

        function updateTableDisplay() {
            let filteredData = [...dataset];

            // Apply search filter
            if (searchTerm) {
                filteredData = filteredData.filter(row =>
                    row.security.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    row.symbol.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    row.sector.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }

            // Apply sorting
            if (currentSort.column) {
                filteredData.sort((a, b) => {
                    let aVal = a[currentSort.column];
                    let bVal = b[currentSort.column];

                    if (typeof aVal === 'number' && typeof bVal === 'number') {
                        return currentSort.direction === 'asc' ? aVal - bVal : bVal - aVal;
                    } else {
                        aVal = String(aVal).toLowerCase();
                        bVal = String(bVal).toLowerCase();
                        if (currentSort.direction === 'asc') {
                            return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                        } else {
                            return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
                        }
                    }
                });
            }

            // Update row count
            document.getElementById('row-count').textContent = filteredData.length;

            // Render table rows
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = filteredData.map(row => `
                <tr>
                    <td class="company-name">${row.security}</td>
                    <td>${row.symbol}</td>
                    <td>${row.sector}</td>
                    <td>${row.weight.toFixed(2)}</td>
                    <td>${formatScore(row.E_adj)}</td>
                    <td>${formatScore(row.v_adj)}</td>
                    <td>${formatScore(row.alpha_adj)}</td>
                    <td>${row.magnitude.toFixed(3)}</td>
                    <td><span class="designation-badge ${getDesignationClass(row.designation)}">${row.designation}</span></td>
                </tr>
            `).join('');
        }

        // Table event listeners
        document.querySelectorAll('.data-table th.sortable').forEach(th => {
            th.addEventListener('click', function() {
                const column = this.dataset.column;

                if (currentSort.column === column) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.column = column;
                    currentSort.direction = 'asc';
                }

                // Update sort indicators
                document.querySelectorAll('.data-table th').forEach(header => {
                    header.classList.remove('sorted-asc', 'sorted-desc');
                });
                this.classList.add(currentSort.direction === 'asc' ? 'sorted-asc' : 'sorted-desc');

                updateTableDisplay();
            });
        });

        document.getElementById('table-search').addEventListener('input', function(e) {
            searchTerm = e.target.value;
            updateTableDisplay();
        });

        // Event listeners
        document.getElementById('btn-3d').addEventListener('click', function() {
            currentView = '3d';
            document.getElementById('btn-3d').classList.add('active');
            document.getElementById('btn-2d').classList.remove('active');
            render3D();
        });

        document.getElementById('btn-2d').addEventListener('click', function() {
            currentView = '2d';
            document.getElementById('btn-2d').classList.add('active');
            document.getElementById('btn-3d').classList.remove('active');
            render2D();
        });

        document.getElementById('sector-filter').addEventListener('change', function(e) {
            currentSectorFilter = e.target.value;
            updateStats();
            if (currentView === '3d') {
                render3D();
            } else {
                render2D();
            }
        });

        document.getElementById('designation-filter').addEventListener('change', function(e) {
            currentDesignationFilter = e.target.value;
            updateStats();
            if (currentView === '3d') {
                render3D();
            } else {
                render2D();
            }
        });
    </script>
</body>
</html>
